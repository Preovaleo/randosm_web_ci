var app=angular.module("RandOSM-CreateHike",["ngAnimate"]);app.controller("StepsCtrl",function($scope){$scope.map={},$scope.tileLayer={},$scope.openedTile={},$scope.steps=[],$scope.editable=!1,$scope.newMap=function(editable,container){$scope.editable=editable,container&&($("#map",container).replaceWith("<div id='map-active'><div id='help'></div></div>"),$("#map-active",container).oncontextmenu=function(){return!1}),$scope.map=L.map("map-active").setView([1,1],13),tileLayer=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo($scope.map);var position=$("#autocomplete",$("#create-hike-form")).val();"undefined"!=typeof position&&(position=position.split(" ")[0],$.getJSON("http://nominatim.openstreetmap.org/search?format=json&limit=5&country=fr&city="+position,function(data){$scope.map.panTo(new L.LatLng(data[0].lat,data[0].lon))})),container&&($("#map-active",container).fadeIn(),$scope.refreshMap()),editable?$scope.map.addControl(helpCtrl).addControl(expandCtrl).on("click",$scope.onMapClick):$("#steps").hide()},$scope.refreshMap=function(){$scope.map.invalidateSize()},$scope.onMapClick=function(e){if("block"==$("#help").css("display"))$("#help").fadeOut();else{var newMarker=L.marker(e.latlng);$scope.editable&&(newMarker.options.draggable=!0,newMarker.on("click",$scope.onMarkerClick).on("contextmenu",$scope.onMarkerRightClick).on("mouseover",$scope.onMarkerHover).on("dragend",$scope.refreshLine)),newMarker.comment="",console.log("leaflet_id"),console.log(newMarker._leaflet_id),$scope.$apply($scope.steps.push(newMarker)),angular.forEach($scope.steps,function(value){value.addTo($scope.map)}),$scope.refreshLine();var el=$("#steps"),curHeight=el.height(),autoHeight=el.css("height","auto").height();el.height(curHeight).animate({height:autoHeight},200,"swing")}},$scope.onMarkerRightClick=function(){var m=this;angular.forEach($scope.steps,function(value){if(value.getLatLng()==m.getLatLng()){$scope.map.removeLayer(value);var i=$scope.steps.indexOf(value);$scope.$apply($scope.steps.splice(i,1));var el=$("#steps"),h=el.height()-80;el.delay(950).animate({height:h},50,"swing")}}),$scope.refreshLine()},$scope.onMarkerHover=function(){var m=this;angular.forEach($scope.steps,function(value){if(value.getLatLng()==m.getLatLng()){var index=$scope.steps.indexOf(value)+1;m.bindPopup("<strong>Étape n<sup>o</sup>"+index+"</strong>").openPopup()}})},$scope.refreshLine=function(){"undefined"!=typeof polyline&&$scope.map.removeLayer(polyline);for(var markersPositions=[],i=0;i<$scope.steps.length;i++)markersPositions[i]=$scope.steps[i].getLatLng();polyline=L.polyline(markersPositions,{color:"#00f47a",weight:3,opacity:.9}).addTo($scope.map),$scope.steps[0].setIcon(greenIcon)},$scope.modifyInfos=function(e){var hikeCard=$(e).parents(".tile"),fields=$("[class$='-field']",hikeCard);console.log($(hikeCard)),fields.each(function(index,value){$(value).replaceWith("<input type='text' name='"+$(value).attr("name")+"' value='"+value.innerText+"'>")});var cityField="input[name='city']";$(cityField,hikeCard).replaceWith('<input type="text" name="city" id="autocomplete" autocomplete="off" class="ui-autocomplete-input" role="textbox" aria-autocomplete="list" aria-haspopup="true" value="'+$(cityField).val()+'">');var radios=$("[class$='-radio']",$(".tile-column1",hikeCard));radios.each(function(index,value){$(value).replaceWith("<input type='radio' name='difficulty' value='1'> 1 <input type='radio' name='difficulty' value='2'> 2 <input type='radio' name='difficulty' value='3'> 3 <input type='radio' name='difficulty' value='4'> 4 <input type='radio' name='difficulty' value='5'> 5"),$("input[type='radio'][value='"+value.innerText+"']",hikeCard).attr("checked","checked")}),$(".shoes",hikeCard).hide(),$(".button2.icon-valid",hikeCard).show(),$(".button2.icon-refuse",hikeCard).show(),$(".button2.icon-map",hikeCard).show(),$(".button2.icon-settings",hikeCard).hide()},$scope.modifyMap=function(e,hikeId){$(e).parent().hide();var timeToWaitBeforeShowing=0;$.isEmptyObject($scope.openedTile)===!1&&(timeToWaitBeforeShowing=1300,$scope.hideDetails()),setTimeout(function(){var tile=$(e).parents(".tile");$(".expand-bar",tile).hide(),$scope.newMap(!0,tile),$scope.getHikeInfos(e,hikeId),$scope.openedTile.tile=tile,$scope.openedTile.hikeId=hikeId,$(".hike-description",tile).fadeIn(),$(".expand-bar.show",tile).hide()},timeToWaitBeforeShowing)},$scope.displayLineAndMarkers=function(){var markersPositions=[];$scope.steps.forEach(function(entry){markersPositions.push(entry.getLatLng())}),$scope.map.fitBounds(markersPositions),polyline=L.polyline(markersPositions,{color:"#00f47a",weight:3,opacity:.9}).addTo($scope.map),$scope.steps.forEach(function(entry){entry.addTo($scope.map)})},$scope.getHikeInfos=function(e,hikeId){$.ajax({url:base_url+"my_hikes/getHikeInfos/"+hikeId,success:function(data){$scope.steps=[];var array=JSON.parse("["+data+"]");array[0].forEach(function(entry){var newMarker=L.marker(entry.latlng);$scope.editable&&(newMarker.options.draggable=!0,newMarker.on("click",$scope.onMarkerClick).on("contextmenu",$scope.onMarkerRightClick).on("mouseover",$scope.onMarkerHover).on("dragend",$scope.refreshLine)),newMarker.comment=entry.comment,$scope.steps.push(newMarker)}),$scope.displayLineAndMarkers()},error:function(){}})},$scope.getHikePhotos=function(tile,hikeId){$.ajax({url:base_url+"my_hikes/getHikePictures/"+hikeId,success:function(data){$scope.displayPictures(tile,JSON.parse(data))},error:function(){}})},$scope.displayPictures=function(tile,picturesLinksArray){picturesLinksArray.forEach(function(value,index){index==picturesLinksArray.length-1?$(".hike-pictures",tile).append("<img src='"+value+"'>").ready(function(){$(".hike-pictures",tile).fadeIn()}):$(".hike-pictures",tile).append("<img src='"+value+"'>")})},$scope.onMarkerClick=function(){m=event.target,console.log("#content",$(m).parents(".content"));$scope.steps.indexOf(this)+1},$scope.showDetails=function(e,hikeId){var timeToWaitBeforeShowing=0;$.isEmptyObject($scope.openedTile)===!1&&(timeToWaitBeforeShowing=1300,$scope.hideDetails()),setTimeout(function(){var tile=$(e).parents(".tile");$scope.newMap(!1,tile),$scope.getHikeInfos(e,hikeId),$scope.getHikePhotos(tile,hikeId),$scope.openedTile.tile=tile,$scope.openedTile.hikeId=hikeId,$(".hike-description",tile).fadeIn(),$(".expand-bar.show",tile).hide(),$(".expand-bar.hide",tile).show()},timeToWaitBeforeShowing)},$scope.hideDetails=function(){if(console.log("---- hideDetails ----"),$.isEmptyObject($scope.openedTile)===!1){{var tile=$scope.openedTile.tile;$scope.openedTile.hikeId}curHeight=tile.height(),$(".expand-bar.hide",tile).hide(),$("img",$(".hike-pictures",tile)).fadeOut(function(){$("img",$(".hike-pictures",tile)).remove()}),tile.css("height",curHeight),$(".hike-description",tile).fadeOut(300),$(".expand-bar",tile).fadeOut(),$("#map-active",tile).fadeOut(function(){$("#map-active",tile).remove(),$("<div id='map'><div id='help'></div></div>").insertBefore($(".expand-bar",tile)),tile.animate({height:"147px"},500,function(){tile.css("height","auto"),$(".expand-bar.show",tile).show()})}),$scope.openedTile={}}},$scope.sendLength=function(){var totalLength=0;if($scope.steps[0]){for(var i=0;i<$scope.steps.length-1;i++)totalLength+=$scope.steps[i].getLatLng().distanceTo($scope.steps[i+1].getLatLng());totalLength=Math.round(totalLength/10)/100}document.getElementById("length").value=totalLength},$scope.modifyHike=function(e,hikeId){var form=$(e).parents("form"),steps=$scope.steps,markers=[];angular.forEach(steps,function(value){marker={latlng:value.getLatLng(),comment:value.comment},markers.push(marker)}),$.ajax({url:base_url+"create_hike/modify_infos",data:{dataString:form.serialize(),hikeId:hikeId},type:"post",success:function(){},error:function(data){alert("Une erreur s'est malheureusement produite :/"),console.log("ajax error :"),console.log(data)}}),$.ajax({url:base_url+"create_hike/modify_steps",data:{markers:JSON.stringify(markers),hikeId:hikeId},type:"post",success:function(data){console.log(data),document.location=base_url+"my_hikes"},error:function(data){alert("Une erreur s'est malheureusement produite :/"),console.log("ajax error :"),console.log(data)}})},$scope.createHike=function(){$scope.steps[0]&&($scope.markers=[],angular.forEach($scope.steps,function(value){marker={latlng:value.getLatLng(),comment:value.comment},$scope.markers.push(marker)})),$.ajax({url:base_url+"create_hike/create",data:{dataString:$("#create-hike-form").serialize(),markers:JSON.stringify($scope.markers)},type:"post",success:function(data){setDropzonesUrl(data),upload()},error:function(data){alert("Une erreur s'est malheureusement produite :/"),console.log("ajax error :"),console.log(data)}})};var ExpandControl=L.Control.extend({options:{position:"topright",expandText:"",expandTitle:"Agrandir la carte"},onAdd:function(t){var e="leaflet-control-expand",i=L.DomUtil.create("div",e+" leaflet-bar");return this._map=t,this._expandButton=this._createButton(this.options.expandText,this.options.expandTitle,e,i,this._expand,this),t.on("_expand",this._updateDisabled,this),i},_expand:function(){$("nav").fadeOut(300),setTimeout(function(){$("div.content").animate({width:"100%"},300,function(){$("div#map-active").animate({height:"420px"},300,function(){expandCtrl.removeFrom($scope.map),$scope.map.addControl(shrinkCtrl)})}),setTimeout(function(){$scope.refreshMap()},200)},300)},_createButton:function(t,e,i,n,s,a){var r=L.DomUtil.create("a",i,n);r.innerHTML=t,r.href="#",r.title=e;var h=L.DomEvent.stopPropagation;return L.DomEvent.on(r,"click",h).on(r,"mousedown",h).on(r,"dblclick",h).on(r,"click",L.DomEvent.preventDefault).on(r,"click",s,a).on(r,"click",this._refocusOnMap,a),r}}),ShrinkControl=L.Control.extend({options:{position:"topright",expandText:"",expandTitle:"Rétrécir la carte"},onAdd:function(t){var e="leaflet-control-shrink",i=L.DomUtil.create("div",e+" leaflet-bar");return this._map=t,this._expandButton=this._createButton(this.options.expandText,this.options.expandTitle,e,i,this._shrink,this),i},_shrink:function(){$scope.shrink()},_createButton:function(t,e,i,n,s,a){var r=L.DomUtil.create("a",i,n);r.innerHTML=t,r.href="#",r.title=e;var h=L.DomEvent.stopPropagation;return L.DomEvent.on(r,"click",h).on(r,"mousedown",h).on(r,"dblclick",h).on(r,"click",L.DomEvent.preventDefault).on(r,"click",s,a).on(r,"click",this._refocusOnMap,a),r}}),HelpControl=L.Control.extend({options:{position:"topright",helpText:"",helpTitle:"Afficher l'aide"},onAdd:function(t){var e="leaflet-control-help",i=L.DomUtil.create("div",e+" leaflet-bar");return this._map=t,this._helpButton=this._createButton(this.options.helpText,this.options.helpTitle,e,i,this._help,this),i},_help:function(){"block"==$("#help").css("display")?$("#help").fadeOut():$("#help").fadeIn()},_createButton:function(t,e,i,n,s,a){var r=L.DomUtil.create("a",i,n);r.innerHTML=t,r.href="#",r.title=e;var h=L.DomEvent.stopPropagation;return L.DomEvent.on(r,"click",h).on(r,"mousedown",h).on(r,"dblclick",h).on(r,"click",L.DomEvent.preventDefault).on(r,"click",s,a).on(r,"click",this._refocusOnMap,a),r}}),expandCtrl=new ExpandControl,shrinkCtrl=new ShrinkControl,helpCtrl=new HelpControl,greenIcon=L.icon({iconUrl:base_url+"assets/images/green-marker.png",iconRetinaUrl:base_url+"assets/images/green-marker-x2.png",shadowUrl:base_url+"assets/images/marker-shadow.png",shadowRetinaUrl:base_url+"assets/images/marker-shadow-x2.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});$scope.shrink=function(){$("div#map-active").animate({height:"300px"},300,function(){$("div.content").animate({width:"72.65625%"},300,function(){$("nav").fadeIn(300,function(){shrinkCtrl.removeFrom($scope.map),$scope.map.addControl(expandCtrl)})})})}});